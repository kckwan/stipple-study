<meta charset="utf-8" />
<meta content="width=device-width, height=device-height, initial-scale=1" name="viewport" />
<link rel="shortcut icon" href="#">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style type="text/css">
	body{ font-size: 24pt;}
	html, body, #wrapper {
      height:100%;
      margin: 0;
      padding: 0;
      border: none;
      text-align: center;
    }
    #wrapper {
      margin: 0 auto;
      text-align: left;
      vertical-align: middle;
      width: 400px;
    }
	div.firstpage, div.page{
		height:80%;
		margin-top:auto;
		margin-bottom:auto;
	}
	div.page { display:none;}
	div.example { 
		width: 60%;
		background-color:#808080;
		margin-top: 10pt;
		margin-bottom: 50pt;
		border: 3px solid #000000;
		color:#FFFFFF;
	}
	h1 { background-color:#70C5E8}
	button.answer { 
		width:auto;
		margin-top: 10pt;
		margin-left: auto;
		margin-right: auto;
		text-align: center;
		font-size: 30px;
	}
	button.large, div.largeButton * { 
		width:60%;
		height: 80pt;
		margin-top: 20pt;
		margin-left: auto;
		margin-right: auto;
		text-align: center;
		font-size: 30px;
	}
	h1 { margin-top:100pt;}
	crowd-input { font-size: 30px; }
</style>
<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<script>
	//Study setting
	var TASK_NUM = 20;
	var REST_TIME = 2000;
	var QUESTION_NUM_BEFORE_REST = 10;
	var MIN_MON_INCH = 17;
	var MIN_MON_RES_W = 800;
	var MIN_MON_RES_H = 600;
	var SMALL_BAR_MOVE = 1;
	var LARGE_BAR_MOVE = 10;
	var fixedAnsQuestion = [2,5,7];
	var methodnames = [ 'color', 'hex', 'hexinvert', 'lloyd', 'lloydinvert','dithering']; 
	var sizelist = [ 3,4,5,6,8,12,17,24];
	var orilist = [ 0, 15, 30, 45 ];
	var intensityNum = 10;
	var minIntensity = 20;
	var intensityStep = 21;
	var filepath = 'https://kckwan-stippling-data.s3.amazonaws.com/data/stipple_';
	//var filepath = '../data/stipple_';
</script>

<!--HTML Page-->
<div class="firstpage" id="mainBody">
	<crowd-form>
	
		<!--To store MTurk Answer-->
		<div id="questionlist">&nbsp;</div>
		
		<!--Introduction-->
		<div id="introduction">
			<center>
				<h1>Intensity Perception Study</h1>
				<h2>Instruction</h2>
				<p style="width:80%;text-align:center">
					Welcome to our study! <BR>
					In this study, you will need to compare pairs of images and tell which one is brighter. Try your best to answer one side even if you cannot distinguish them.  <BR>
					You will need to answer 100 questions; each of them may spend you 3~6 seconds. <BR>
					The time is recorded. Please answer the questions as soon as possible. <BR>
					After answering one question, the image will disappear for 2 seconds for you to rest your eyes. <BR> 
					There are breaks for you to rest after certain questions. <BR> 
					Some questions may have default answers. Answering them wrongly may cause your answer unaccepted. <BR>
					If you have any questions, feel free to send me an email (kin-chung.kwan@uni-konstanz.de). <BR>
					<BR>
					Requirement: A 17+ inch monitor with 800x600 resolution or above.
				</p>
				<div class="example">
					<p>Example Question</p>
						<div style="width: 100%; display: table;margin-bottom:20pt;">
							<div style="display: table-row">
								<div style="width: 50%; display: table-cell">
									<center>
										<div style="width:min(80%,300pt);height:0;padding-bottom:min(80%,300pt);background-color:#333333">&nbsp;</div>
									</center>
								</div>
								<div style="display: table-cell">
									<center>
										<div style="width:min(80%,300pt);height:0;padding-bottom:min(80%,300pt);background-color:#999999">&nbsp;</div>
									</center>
								</div>
						</div>
						<div style="display: table-row">
							<div style="display: table-cell">
								<center><button class="answer" type="button">Left is brighter</button></center>
							</div>
							<div style="display: table-cell">
								<center><button class="answer" type="button">Right is brighter</button></center>
							</div>
						</div>
					</div>
				</div>
				<p><b style="color:red">* CAUTION: You may lose the progress if you refresh, back page, or close the brower! *</b></p>
				<button class="large" onclick="introEnd()" type="button">Next!</button>
			</center>
		</div>
		
		<!--Set up screen-->
		<div class="page" id="setup1" style="margin-top:100pt">
			<center>
				<h1>Intensity Perception Study</h1>
				<h2>Configuration</h2>
					<p style="width:80%">
						To perform this online study, you need to tell us your your computer setting.<br />
						Now, please <b>maximum</b> your brower by the &#39;Maximize&#39; button on the top of your browers and then input the following information: <crowd-input id="mon_model" label="Your monitor model" name="mon_model"></crowd-input>
					</p>
				<table style="width:80%">
					<tbody>
						<tr>
							<td style="width:29%;padding-left:2%;padding-right:2%;"><crowd-input allowed-pattern="[0-9]" auto-validate="true" error-message="Number only" id="mon_size" label="Your monitor size in inch (diagonally)" max-length="3" name="mon_size"></crowd-input></td>
							<td>:</td>
							<td style="width:29%;padding-left:2%;padding-right:2%;"><crowd-input allowed-pattern="[0-9]" auto-validate="true" error-message="Number only" id="mon_res_w" label="Your monitor resolution (Width)" max-length="5" name="mon_res_w"></crowd-input></td>
							<td>x</td>
							<td style="width:29%;padding-left:2%;padding-right:2%;"><crowd-input allowed-pattern="[0-9]" auto-validate="true" error-message="Number only" id="mon_res_h" label="Your monitor resolution (Height)" max-length="5" name="mon_res_h"></crowd-input></td>
							<td style="width:13%;padding-left:2%;padding-right:2%;"><crowd-modal link-text="How to know?" link-type="button">
							<h2>How to know your monitor resolution</h2>
							For <select name="os" onchange="osChange(this.value, 'hints1')"><option value="win">Windows</option><option value="mac">Mac</option></select>

							<div id="win_hints1">
							<ol>
								<li>Right click an empty space in your desktop.</li>
								<li>Select &quot;Display settings&quot; in the menu.</li>
								<li>Look for &quot;Resolution&quot;</li>
							</ol>

							<center><img src="https://kckwan-stippling-data.s3.amazonaws.com/img/resolutionhints.png" /></center>
							</div>

							<div id="mac_hints1" style="display:none">
							<ol>
								<li>Click the Mac icon at the top-left corner.</li>
								<li>Click Display in the tag.</li>
								<li>Look for the resolution.</li>
							</ol>

							<center><img src="https://kckwan-stippling-data.s3.amazonaws.com/img/resolutionhints3.jpg" /></center>
							</div>
							</crowd-modal></td>
						</tr>
					</tbody>
				</table>

				<div id="mon_err" style="color:red">&nbsp;</div>
				<button class="answer" id="monsetupButton" onclick="monInput()" style="width:100pt" type="button">Setup</button>

				<div id="setuplist">&nbsp;</div>

				<p>&nbsp;</p>

				<table style="width:100%">
					<tbody>
						<tr>
							<td>
							<center><button class="large" id="setupBackButton" onclick="setupBack()" type="button">Back</button></center>
							</td>
							<td>
							<center><button class="large" id="setupNextButton" onclick="setupEnd()" type="button">Next</button></center>
							</td>
						</tr>
					</tbody>
				</table>
			</center>
		</div>
		
		<!--Set up image-->
		<div class="page" id="setup2">
			<center>
				<h1>Intensity Perception Study</h1>

				<h2>Configuration 2</h2>

				<p style="width:80%">Now, please pick up your credit card from the pocket, and place it onto the monitor near the red bar. You need to set the red bar to the same length with the longest edge of your credit card.</p>

				<div><crowd-modal link-text="How to put the card?" link-type="button">
				<h2>How to put the card?</h2>

				<center><img src="https://kckwan-stippling-data.s3.amazonaws.com/img/instruction.png" style="width:100%" /></center>
				</crowd-modal></div>

				<center>
				<table id="wrapper" style="height:85%;width:auto;border: 0">
					<tbody>
						<tr style="vertical-align: top;">
							<td style="margin-left:100pt;width:30%">
							<center>
							<div id="bar" style="margin-top:30pt;margin-bottom:30pt;width:40pt;height:550px;background-color:red">&nbsp;</div>
							</center>
							</td>
							<td style="width:30%">
							<center>
							<table style="vertical-align: top;margin-top:10%">
								<tbody>
									<tr>
										<td><button onclick="barUp10()" type="button"><i class="material-icons" style="color:red">arrow_upward</i></button></td>
										<td>Longer (Fast +10)</td>
									</tr>
									<tr>
										<td><button onclick="barUp1()" type="button"><i class="material-icons" style="color:red">arrow_upward</i></button></td>
										<td>Longer (Slow +1)</td>
									</tr>
									<tr>
										<td colspan="2">
										<div style="margin-top:5pt;margin-bottom:25pt;width:100pt">
										<center><crowd-input allowed-pattern="[0-9]" auto-validate="true" disabled="disabled" error-message="Number only" id="img_res_h" max-length="5" name="img_res_h" value="550"></crowd-input></center>
										</div>
										</td>
									</tr>
									<tr>
										<td><button onclick="barDown1()" type="button"><i class="material-icons" style="color:red">arrow_downward</i></button></td>
										<td>Shorter (Slow -1)</td>
									</tr>
									<tr>
										<td><button onclick="barDown10()" type="button"><i class="material-icons" style="color:red">arrow_downward</i></button></td>
										<td>Shorter (Fast -10)</td>
									</tr>
								</tbody>
							</table>
							</center>
							</td>
						</tr>
					</tbody>
				</table>
				</center>

				<table style="width:100%">
					<tbody>
						<tr>
							<td>
							<center><button class="large" id="setupBackButton" onclick="setupBack2()" type="button">Back</button></center>
							</td>
							<td>
							<center><button class="large" id="setupNextButton" onclick="setupEnd2()" type="button">Next</button></center>
							</td>
						</tr>
					</tbody>
				</table>
			</center>
		</div>
		
		<!--Set up gamma-->
		<div class="page" id="setup3">
			<center>
				<h1>Intensity Perception Study</h1>

				<h2>Configuration 3</h2>
				<img src="https://kckwan-stippling-data.s3.amazonaws.com/img/gamma.png" />
				<p style="width:80%">
					Now, you see an image with color bars along with another set of colors blocks with number.<br />
					Which color blocs has the most similar color to bar?<br />
					Please write down the number in the box below.
				</p>
				<div style="font-size:30pt;width:50%;border: 2px black solid"><crowd-input allowed-pattern="[0-9]|[.]" auto-validate="true" error-message="Number only" id="gamma" label="Your monitor gamma value" name="gamma" required="" style="font-size:30pt" value="2.2"></crowd-input></div>
				<div id="gamma_err" style="color:red">&nbsp;</div>
				<div>
					<table style="width:100%">
						<tbody>
							<tr>
								<td>
									<center><button class="large" id="setupBackButton" onclick="setupBack3()" type="button">Back</button></center>
								</td>
								<td>
									<center><button class="large" id="setupNextButton" onclick="setupEnd3()" type="button">Next</button></center>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</center>
		</div>
		
		<!--Ready?-->
		<div class="page" id="setup4">
			<center>
				<h1>Intensity Perception Study</h1>
				<h2>Ready to start</h2>
				<table style="margin-bottom:100pt">
					<tbody>
						<tr>
							<td style="vertical-align: bottom">
							<center><img src="https://kckwan-stippling-data.s3.amazonaws.com/img/distance.png" style="width:80%" /></center>
							</td>
							<td style="width:100pt">&nbsp;</td>
							<td  style="vertical-align: bottom">
							<center><img src="https://kckwan-stippling-data.s3.amazonaws.com/img/reflection.png" style="width:80%" /></center>
							</td>
							<td  style="vertical-align: bottom">
							<center><img src="https://kckwan-stippling-data.s3.amazonaws.com/img/timer.png" style="width:80%" /></center>
							</td>
						</tr>
					</tbody>
				</table>
				<table style="width:100%">
					<tbody>
						<tr>
							<td>
								<center><button class="large" id="setupBackButton" onclick="setupBack4()" type="button">Back</button></center>
							</td>
							<td>
								<center><button class="large" id="setupNextButton" onclick="setupEnd4()" type="button">Start!</button></center>
							</td>
						</tr>
					</tbody>
				</table>
			</center>
		</div>
		
		<!--Question template-->
		<div class="page" id="questions">
			<div id="questionTest" style="margin-top:100pt;margin-bottom:100pt;color:white">Let&#39;s Start!</div>
			<center>
				<table id="questionTable">
					<tbody>
						<tr style="height:100pt">
						</tr>
						<tr>
							<td>
							<div id="imageA">&nbsp;</div>
							</td>
							<td style="width:200pt">&nbsp;</td>
							<td>
							<div id="imageB">&nbsp;</div>
							</td>
						</tr>
						<tr style="height:100pt">
						</tr>
						<tr>
							<td>
								<center><button class="large" onclick="answerLeft()" type="button">Left is brighter</button></center>
							</td>
							<td>&nbsp;</td>
							<td>
								<center><button class="large" onclick="answerRight()" type="button">Right is brighter</button></center>
							</td>
						</tr>
					</tbody>
				</table>
			</center>
		</div>
		
		<!--Page for resting-->
		<div class="page" id="restPage">
			<div style="margin-top:100pt;margin-bottom:100pt;color:white">Rest time! You can have a rest for a while if you need.</div>
			<center>
				<img src="https://kckwan-stippling-data.s3.amazonaws.com/img/Coffee.png" style="width:20%" /><BR>
				<button class="large" onclick="restOK()" type="button">OK now. I can keep going.</button>
			</center>
		</div>
		
		<!--Page for Error-->
		<div class="page" id="errorPage">
			<center>
				<h2>The known answer are answered incorrectly<br />
				Sorry, your answer cannot be accepted.</h2>
			</center>
		</div>
		
		<!--Page for Submission-->
		<div class="page" id="endStudy">
			<center>
				<h2>Please submit your answer using this button:</h2>
				<crowd-button form-action="submit" style="display:none"></crowd-button><button class="large" onclick="studyEnd()" type="button">Submit.</button>
			</center>
		</div>
		
		<!--Page for Ending-->
		<div class="page" id="thankyoupage">
			<center>
				<h1>The End</h1>
				<h2>Thank you for participants!</h2>
			</center>
		</div>
	</crowd-form>
</div>


<script>
	var mon_model = '';
	var mon_size = 0;
	var mon_res_w = 0;
	var mon_res_h = 0;
	var mon_ratio = [0,0];
	var img_res_h = 550;
	var current_Page = '';
	var current_Question = '';
	var startTime = 0;
	var answered_question_num = 0;
	var next_question_index = 0;
	var error_diffusion = 0;
	var black_pixel_count = 0;
	
	var intensity = [];
	var intensity2 = [];
	//var filenames = [];
	var sizeIds = [];
	var methodIds = [];
	var oriIds = [];

	//var is_question_answered = [];
	var answers = [];
	var answering_time = [];
	var isPrepared = false;
	var drawCompleted = [false, false];
	var gamma = 2.2;
	var rested = false;
	var isScaleFixed = false;
	//var isAA = false;
	//var isInverted = false;
	
	//UI Function
	
	//start main function
	initQuestions();
	function initQuestions(){
		window.addEventListener('resize',checkSetting);
		document.getElementById('setupNextButton').disabled = true;
		for(let i = 0; i < TASK_NUM; i++){
			document.getElementById('questionlist').innerHTML += '<crowd-input id=\'answer' + i + '\' name=\'answer' + i + '\' label=\'Word/phrase 1\' style=\'display: none;\'></crowd-input>';
			document.getElementById('questionlist').innerHTML += '<crowd-input id=\'time' + i + '\' name=\'time' + i + '\' label=\'Word/phrase 1\' style=\'display: none;\'></crowd-input>';
			document.getElementById('questionlist').innerHTML += '<crowd-input id=\'MA' + i + '\' name=\'MA' + i + '\' label=\'Word/phrase 1\' style=\'display: none;\'></crowd-input>';
			document.getElementById('questionlist').innerHTML += '<crowd-input id=\'IA' + i + '\' name=\'IA' + i + '\' label=\'Word/phrase 1\' style=\'display: none;\'></crowd-input>';
			document.getElementById('questionlist').innerHTML += '<crowd-input id=\'SA' + i + '\' name=\'SA' + i + '\' label=\'Word/phrase 1\' style=\'display: none;\'></crowd-input>';
			document.getElementById('questionlist').innerHTML += '<crowd-input id=\'OA' + i + '\' name=\'OA' + i + '\' label=\'Word/phrase 1\' style=\'display: none;\'></crowd-input>';
			document.getElementById('questionlist').innerHTML += '<crowd-input id=\'MB' + i + '\' name=\'MB' + i + '\' label=\'Word/phrase 1\' style=\'display: none;\'></crowd-input>';
			document.getElementById('questionlist').innerHTML += '<crowd-input id=\'IB' + i + '\' name=\'IB' + i + '\' label=\'Word/phrase 1\' style=\'display: none;\'></crowd-input>';
			document.getElementById('questionlist').innerHTML += '<crowd-input id=\'SB' + i + '\' name=\'SB' + i + '\' label=\'Word/phrase 1\' style=\'display: none;\'></crowd-input>';
			document.getElementById('questionlist').innerHTML += '<crowd-input id=\'OB' + i + '\' name=\'OB' + i + '\' label=\'Word/phrase 1\' style=\'display: none;\'></crowd-input>';
			document.getElementById('questionlist').innerHTML += '<crowd-input id=\'average_colorA' + i + '\' name=\'average_colorA' + i + '\' label=\'Word/phrase 1\' style=\'display: none;\'></crowd-input>';
			document.getElementById('questionlist').innerHTML += '<crowd-input id=\'average_colorB' + i + '\' name=\'average_colorB' + i + '\' label=\'Word/phrase 1\' style=\'display: none;\'></crowd-input>';
		}
	}
	function osChange(v,q){
		document.getElementById("win" + "_" + q).style.display = "none";
		document.getElementById("mac" + "_" + q).style.display = "none";
		//document.getElementById("linux" + "_" + q).style.display = "none";
		document.getElementById(v + "_" + q).style.display = "block";
	}
	function changePage(page_from,page_to){
		document.getElementById(page_from).style.display = "none";
		document.getElementById(page_to).style.display = "block";
		current_Page = page_to;
	}
	function introEnd(){   changePage('introduction','setup1'); 	}
	function setupBack(){  changePage('setup1','introduction'); 	}
	function setupEnd(){   
		if(monInput()){
			isScaleFixed = true;
			changePage('setup1','setup2');	    	
		}
	}
	function setupBack2(){ 
		isScaleFixed = false;
		changePage('setup2','setup1');			
	}
	function setupEnd2(){  changePage('setup2','setup3');			}
	function setupBack3(){ changePage('setup3','setup2');			}
	function setupEnd3(){  changePage('setup3','setup4');			}
	function setupBack4(){ changePage('setup4','setup3');			}
	function setupEnd4(){  
		prepareQuestions();
		changePage('setup4','questions');	
	}
	function studyEnd(){   
		document.body.style.backgroundColor = '#FFFFFF';
		changePage('endStudy','thankyoupage');
		document.querySelector('crowd-form').submit();
	}
	
	function monInput(){
		mon_model = document.getElementById('mon_model').value;
		mon_size = parseInt(document.getElementById('mon_size').value);
		mon_res_w = parseInt(document.getElementById('mon_res_w').value);
		mon_res_h = parseInt(document.getElementById('mon_res_h').value);
		if (checkMonInputValue()){ 
			if(checkSetting()){
				calculateCreditCardSize();
				return true;
			}
		}
		document.getElementById('setupNextButton').disabled = true;
		return false;
	}
	
	function calculateCreditCardSize(){
		mon_ratio = mon_res_h / mon_res_w ;
		// h = w * r
		// h^2+ (h/r)^2 = c^2
		// h^2 ( 1 + r ^2 ) / r ^2 = c^2
		// h sqrt( 1 + r ^2 ) / r  = c
		// h = r c / sqrt( 1 + r^2 )
		mon_height_inch = mon_ratio * mon_size / Math.sqrt( 1.0 + mon_ratio * mon_ratio);
		card_ratio = (3.375) / mon_height_inch;
		img_res_h = Math.floor(mon_res_h * card_ratio);
		document.getElementById('img_res_h').value = img_res_h;
		document.getElementById('bar').style.height = img_res_h + "px";
	}
	function checkMonInputValue(){
		document.getElementById('mon_err').innerHTML = '';
		if (mon_model.length == 0) document.getElementById('mon_err').innerHTML = 'The model cannot be empty';
		if (isNaN(mon_size) || mon_size <= 0) document.getElementById('mon_err').innerHTML = 'The monitor size cannot be empty or negative';
		if (isNaN(mon_res_w) || mon_res_w <= 0) document.getElementById('mon_err').innerHTML = 'The resolution cannot be empty or negative';
		if (isNaN(mon_res_h) || mon_res_h <= 0) document.getElementById('mon_err').innerHTML = 'The resolution cannot be empty or negative';
		if (mon_size < MIN_MON_INCH) document.getElementById('mon_err').innerHTML = 'We require a monitor with ' + MIN_MON_INCH+ ' inch or above.';
		if (mon_res_w < MIN_MON_RES_W|| mon_res_h < MIN_MON_RES_H)document.getElementById('mon_err').innerHTML = 'We require a monitor with resolution more than '+MIN_MON_RES_W+' x ' + MIN_MON_RES_H;
		/*if (!isRatioAccepted()) { 
			document.getElementById('mon_err').innerHTML = 'This resolution is not accepted in our study.';
			return false;}*/
		return (document.getElementById('mon_err').innerHTML == '');
	}
	
	//check if the ratio of monitor is reasonable
	function isRatioAccepted(){
		return true;
		//var diff = 0;
		//for (const ratio of ACCEPTED_RATIO) {
			//diff = (mon_res_h / ratio[1] * ratio[0]) / mon_res_w;
			//if(diff > 0.95 && diff < 1.05) return true; 
			
			//diff = (mon_res_w / ratio[1] * ratio[0]) / mon_res_h;
			//if(diff > 0.95 && diff < 1.05) return true;
		//}
		//return false;
	}
	
	function checkSetting(){
		if(isScaleFixed){
			alert("Error: You should not resize the windows during the experiement.");
			isScaleFixed = false;
			document.body.style.backgroundColor = '#FFFFFF';
			changePage(current_Page,'setup1');
		}
		document.getElementById('setupNextButton').disabled = true;
	
		var screenPixelRatio = (window.outerWidth) / window.innerWidth;
		var isAtDefaultZoom = screenPixelRatio > 0.95 && screenPixelRatio <= 1.05;
		var isResolutionOK = ( mon_res_w == screen.availWidth && mon_res_h == screen.availHeight )

		document.getElementById('setuplist').innerHTML = '<h2>Checklist</h2>';
		document.getElementById('setuplist').innerHTML += ("<p><b>Detected screen resolution: </b>" + screen.availWidth + " x " + screen.availHeight
		+ (isResolutionOK ? " <span style='color:green'>✔</span>"
		: " <i class=\"material-icons\" style='color:red' >report_problem</i>"
		+ "<crowd-modal link-text = \"Info\" link-type = \"button\"> The detected screen resolution is different from your input. It can be caused by some scaling features of your operation system or graphic hardware driver. Please disable those scaling of native output in your operating system. <BR><BR> For Windows: <BR>" +
			" 1. Right click an empty space in your desktop.  <BR>" +
			" 2. Select &quot;Display settings&quot; in the menu. <BR>" +
			" 3. Look for \"Scale and layout\" <BR>" +
			"<img src='https://kckwan-stippling-data.s3.amazonaws.com/img/window_zoom.png' /> <BR> <BR>" +
		"For Mac: <BR>" +
			"1. Click the Mac icon at the top-left corner.<BR>" +
			"2 .Click Display in the tag.<BR>" +
			"3. Select \"Best for display\"<BR>" +
			"<img src='https://kckwan-stippling-data.s3.amazonaws.com/img/mac_zoom.jpg' /><BR>" +
		"</crowd-modal>"));
		document.getElementById('setuplist').innerHTML += ("<p><b>Browser Zoom: </b>" + (screenPixelRatio * 100.0).toFixed(2)
		+ (isAtDefaultZoom ? "% <span style='color:green'>✔</span>"
		: "% <i class=\"material-icons\" style='color:red' >report_problem</i>"
		+ "<crowd-modal link-text = \"Info\" link-type = \"button\"> Zoom in/out is detected. Please set the zoom of your brower to 100%. You can do so by clicking the setting of your browers. <BR> Example for Chrome : <BR> <img src='https://kckwan-stippling-data.s3.amazonaws.com/img/browser.png'/></crowd-modal>"));
		
		if(isAtDefaultZoom && isResolutionOK){
			document.getElementById('setupNextButton').disabled = false;
			return true;
		}else{
			return false;
		}
	}
	
	function barUp1()	{ barUpdate(SMALL_BAR_MOVE) }
	function barUp10()	{ barUpdate(LARGE_BAR_MOVE) }
	function barDown1()	{ barUpdate(-SMALL_BAR_MOVE) }
	function barDown10(){ barUpdate(-LARGE_BAR_MOVE) }
	function barUpdate(value){
		img_res_h += value;
		if(img_res_h < 1) img_res_h = 1;
		document.getElementById('img_res_h').value = img_res_h;
		document.getElementById('bar').style.height = img_res_h + "px";
	}
	
	
	//Maths Functions
	
	function getColor(value) {
		var v = ('0' + Math.floor(value).toString(16)).substr(-2);
		var color = '#' + v + v + v + "FF";
		//console.log(color);
		return color;
	}
	function getRandomColor() {
		var v = ('0' + Math.floor(Math.random() * 255).toString(16)).substr(-2);
		var color = '#' + v + v + v + "FF";
		//console.log(color);
		return color;
	}
	function gammaCorrection(v){
		return Math.round( Math.pow(v / 255.0, 1.0 / gamma) * 255.0);
	}
	
	//Circle Area Begin, modified from C++ Code in StackOverflow
	function g(x,h,r){ 
		return 0.5 * ( Math.sqrt(1 - x * x / (r * r)) * x * r + r * r * Math.asin(x / r) - 2 * h * x );				
	}
	function area2(x0,x1,h,r){
		if (x0 > x1) [x0, x1] = [x1,x0];
		let s = (h < r) ? Math.sqrt(r * r - h * h) : 0;
		return g(Math.max(-s, Math.min(s, x1)), h, r) - g(Math.max(-s, Math.min(s, x0)), h, r);
	}
	function area1(x0,x1,y0,y1,r)
	{
		if (y0 > y1) [y0,y1] = [y1, y0];
		if (y0 < 0) {
			if (y1 < 0) return area1(x0, x1, -y0, -y1, r); 
			else return area1(x0, x1, 0, -y0, r) + area1(x0, x1, 0, y1, r);
		}else return area2(x0, x1, y0, r) - area2(x0, x1, y1, r); 
	}
	function area(x0, x1, y0, y1, cx, cy, r)
	{
		x0 -= cx; x1 -= cx;
		y0 -= cy; y1 -= cy;
		return area1(x0, x1, y0, y1, r);
	}
	//Circle Area End 
	
	
	function norm(x,y,x2,y2){
		return Math.sqrt( Math.pow(x2-x,2) + Math.pow(y2-y,2));
	}
	function normRGB(c){
		return Math.sqrt( c[0] * c[0] + c[1] * c[1] + c[2] * c[2]);
	}
	function gammaCorrectionRGB(c){
		return [
			gammaCorrection(c[0]),
			gammaCorrection(c[1]),
			gammaCorrection(c[2])
			];
	}
	function color2String(c){
		return 'rgb('+c[0]+','+c[1]+','+c[2]+')';
	}
	
	//Questions Function
	
	
	function prepareQuestions(){ 
		createQuestions();
		//read the gamma reading
		gamma = document.getElementById('gamma').value;
		//setup background
		document.body.style.backgroundColor = '#808080';
		//console.log(img_res_h);
		document.getElementById('imageA').style.height = img_res_h + 'px';
		document.getElementById('imageA').style.width  = img_res_h + 'px';
		document.getElementById('imageB').style.height = img_res_h + 'px';
		document.getElementById('imageB').style.width  = img_res_h + 'px';
		next_question_index = -1;
		nextQuestion();
	}
	function createQuestions(){	
		if(isPrepared) return;
		//init
		for(let i = 0; i < TASK_NUM; i++){
			//is_question_answered[i] = 0;
			answers[i] = -1;
			answering_time[i] = -1;
		}
		//readCSVQuestions();
		generateRandomQuestions();
		isPrepared = true;
	}
	//read the Amazon MTurk CSV File
	function readCSVQuestions(){}
	//Generate random questions on the fly
	function generateRandomQuestions(){	
		for(let i = 0; i < TASK_NUM; i++){
			var randomOffset = (Math.random() < 0.5) ? 0 : 1;	//left or right
			var idA = i * 2 +  randomOffset;
			var idB = i * 2 +  (1 - randomOffset);

			var isFixed = false;
			fixedAnsQuestion.forEach(
				function (item, index) {
					if(item == i) isFixed = true;
				}
			);
			//if(i != fixedAnsQuestion[0] && i != fixedAnsQuestion[1] && i != fixedAnsQuestion[2]){	
			if(!isFixed){
				methodIds[idA] = Math.floor(Math.random() * (methodnames.length));	//stippling img
				methodIds[idB] = 0;	//color img
				intensity[idA] = (Math.floor(Math.random() * intensityStep)) * intensityNum + minIntensity;
				intensity[idB] = (Math.floor(Math.random() * intensityStep)) * intensityNum + minIntensity;
			}else{ //fixed answer
				methodIds[idA] = 0;	//stippling img
				methodIds[idB] = 0;	//color img
				intensity[idA] = intensityStep * intensityNum + minIntensity;	//brightest
				intensity[idB] = minIntensity;	//darkest
			}
			sizeIds[idA] = sizelist[Math.floor(Math.random() * sizelist.length)];
			sizeIds[idB] = sizelist[Math.floor(Math.random() * sizelist.length)];
			oriIds[idA] = ( isHex(methodIds[idA]) ) ? orilist[Math.floor(Math.random() * orilist.length)]: 0;
			oriIds[idB] = ( isHex(methodIds[idB]) ) ? orilist[Math.floor(Math.random() * orilist.length)]: 0;
		}
	}
	function isHex(id){ return (id == 1 || id == 2);}
	
	function drawCircle(ctx, ptx, pty , radius){
		//ctx.beginPath();
		//ctx.arc(x,y,r, 0, 2 * Math.PI);	
		//ctx.fillStyle = "black";
		//ctx.fill();
		
		var sign = 1;
		
		//pixel of circle center
		//if (isInverted) ctx.fillStyle="white";
		//else ctx.fillStyle="black";
		let cx = Math.round(ptx);
		let cy = Math.round(pty);
		let end = Math.ceil(radius);
		let radius_sqr = end * end;
		for (let x = -end; x <= end; ++x) {
			let px = cx + x;         //Move from center 
			if (px < 0 || px > img_res_h - 1) continue;
			for (let y = -end; y <= end; ++y) {
				py = cy + y;            //Move from center 
				if (py < 0 || py > img_res_h - 1) continue;
				
				
				//
				//cv::Vec3b* p = (cv::Vec3b*)(img.ptr(py)) + px;
				//if ((*p) == c) continue;
				let outter_corner_x = (x >= 0) ? px + 0.5 : px - 0.5;
				let outter_corner_y = (y >= 0) ? py + 0.5 : py - 0.5;
				let inner_corner_x = (x < 0) ? px + 0.5 : px - 0.5;
				let inner_corner_y = (y < 0) ? py + 0.5 : py - 0.5;
			
				//let color = ctx.getImageData(px,py, 1, 1).data;
				if (norm(ptx,pty, outter_corner_x, outter_corner_y) < radius){
					//let color = ctx.getImageData(px,py, 1, 1).data;
					//console.log('a');
					//var r,g,b;
					/*if (isInverted){
						ctx.fillStyle="white";
						//r = g = b = 255;
						//sign = -1;
					}else{ 
						ctx.fillStyle="black";
						//r = g = b = 0;
					}*/
					/*if(color[0] == r && color[1] == g && color[2] == b)	//overdraw
						error_diffusion += sign;
					else*/
						ctx.fillRect( px, py, 1, 1 );   //inside circle
				}else if (
					norm(ptx,pty, inner_corner_x, inner_corner_y) <= radius ||            //border case
					(x==0 && y==0 && radius <= 1.0)                     //center case
					)
				{
					let a = Math.min(1.0,Math.max(0.0,area(px - 0.5, px + 0.5, py - 0.5, py + 0.5, ptx, pty, radius)));
					//if(isAA){
						
						/*if (!isInverted){
							let new_color = [
								color[0] * (1.0 - a),
								color[1] * (1.0 - a),
								color[2] * (1.0 - a)
							];
							new_color = gammaCorrectionRGB(new_color);
							
							if (normRGB(new_color) < normRGB(color)){
								ctx.fillStyle = color2String(new_color);
								ctx.fillRect( px, py, 1, 1 ); 
							}
						}else{
							let new_color = [
								color[0] * (1.0 - a) + 255 * a,
								color[1] * (1.0 - a) + 255 * a,
								color[2] * (1.0 - a) + 255 * a
							];
							new_color = gammaCorrectionRGB(new_color);
							if(normRGB(new_color) > normRGB(color)){
								ctx.fillStyle = color2String(new_color);
								ctx.fillRect( px, py, 1, 1 ); 
							}
						}*/
					//}else
					{
						//No AA
						//let color = ctx.getImageData(px,py, 1, 1).data;
						//error_diffusion = 0;
						if(a >= 0.5){
						//if(error_diffusion + a >= 0.5){
							//var r,g,b;
							/*if (isInverted){
								ctx.fillStyle="white";
								//r = g = b = 255;
								//sign = -1;
							}else{ 
								ctx.fillStyle="black";
								//r = g = b = 0;
							}*/
							//if(color[0] == r && color[1] == g && color[2] == b)	//overdraw
								//error_diffusion += a * sign;
							//else
							{
								//error_diffusion -= (1.0 - a) * sign;	//new draw
								ctx.fillRect( px, py, 1, 1 ); 
							}
						}/*else{
							error_diffusion += a * sign;;
						}*/
					}
				}
			}
		}
		
	}
	function avgColor(ctx){
		//console.log("AVG");
		var imgData = ctx.getImageData(0, 0, img_res_h, img_res_h).data;
		var pixelSum = 0;
		for(let i=0; i<= imgData.length; i+=4){
			pixelSum += (imgData[i] > 128 ? 255 : 0);
		}
		
		pixelSum /= img_res_h * img_res_h;
		return pixelSum;
	}
	function startDisplay(){
		if(drawCompleted[0] && drawCompleted[1]){
			document.getElementById('questionTable').style.display = "table";
			startTime = Date.now();
		}else{
			setTimeout( startDisplay , 100);
		}
	}			
	function nextQuestion() {
		
		//clear the page
		document.getElementById('questionTable').style.display = "none";
		document.getElementById('imageA').innerHTML = "";
		document.getElementById('imageB').innerHTML = "";
		drawCompleted[0] = false;
		drawCompleted[1] = false;
		//next_question_index = Math.floor(Math.random() * TASK_NUM);
		//while(is_question_answered[next_question_index]){
			//next_question_index = (next_question_index+1) % TASK_NUM;
		//}
		
		//next questions
		do{
			next_question_index++;
		}while(answered[next_question_index]);
		setTimeout( startDisplay , REST_TIME);
		
		//Create images
		console.log(methodIds[next_question_index * 2]);						 
		console.log(methodIds[next_question_index * 2 + 1]);						 
		console.log(intensity[next_question_index * 2]);						 
		console.log(intensity[next_question_index * 2 + 1]);						 
		document.getElementById('questionTest').innerHTML = "Question " + (answered_question_num+1) + " / " + TASK_NUM + "<BR> Which one is brighter?";
		draw('A',next_question_index * 2);
		draw('B',next_question_index * 2 + 1);
	}
	function draw(canvasName, next_question_index){
		if(methodIds[next_question_index] == 0){
			drawColor(canvasName,next_question_index);
		}else if (methodIds[next_question_index] <= 4){
			drawStippling(canvasName,next_question_index);
		}else if (methodIds[next_question_index] == 5){
			drawDithering(canvasName,next_question_index);
		}else{
			console.log("Unknown method : " + methodnames[methodIds[next_question_index]] + "(" +methodIds[next_question_index] +")");
		}
	}
	function getCanvasNum(name){
		if(name == 'A') return 0;
		else if(name == 'B') return 1;
	}
	function drawColor(canvasName, index){
		document.getElementById('average_color' + canvasName + Math.floor(index/2)).value = intensity[index];
		document.getElementById('image' + canvasName).style.backgroundColor  = getColor(intensity[index]);//getRandomColor();
		drawCompleted[getCanvasNum(canvasName)] = true;
	}
	function drawDithering(canvasName,next_question_index){
		var size = sizeIds[next_question_index];					
		/*
		//One block of pattern to copy
		var p_size_2 = PATTERN_SIZE * PATTERN_SIZE;
		var num = Math.round((1.0 - intensity[next_question_index] / 255) * p_size_2);
		var pattern;
		if(num < 128){
			pattern = Array(p_size_2).fill(1);
			for(let i = 0; i < p_size_2 - num ; ++i)
			{
				var id = Math.floor(Math.random() * p_size_2);
				while(pattern[id] == 0){ id = (id + 1) % p_size_2; }
				pattern[id] = 0;
			}
		}else{
			pattern = Array(p_size_2).fill(0);
			for(let i = 0; i < num ; ++i)
			{
				var id = Math.floor(Math.random() * p_size_2);
				while(pattern[id] == 1){ id = (id + 1) % p_size_2; }
				pattern[id] = 1;
			}
		}*/
		
		var canvas = document.createElement('canvas');
		canvas.id     = "dithering";
		canvas.width  = img_res_h;
		canvas.height = img_res_h;
		canvas.style.zIndex   = 0;
		canvas.style.position = "absolute";
		var ctx = canvas.getContext("2d");
		//background
		ctx.fillStyle="white";
		ctx.fillRect(0,0,img_res_h,img_res_h);
		//foreground
		ctx.fillStyle="black";
		for (let x = 0; x < img_res_h; x += size){
			for (let y = 0; y < img_res_h; y += size){
				if(Math.floor(Math.random() * 255 > intensity[next_question_index]))
					ctx.fillRect(x,y,size,size);
				/*if(pattern[((y/size) % PATTERN_SIZE) * PATTERN_SIZE + ((x/size) % PATTERN_SIZE)] == 1){
					ctx.fillRect(x,y,size,size);
				}*/
			}
		}
		var average_color = avgColor(ctx);
		console.log(average_color);						 
		document.getElementById('average_color' + canvasName + Math.floor(next_question_index/2)).value = average_color;
		document.getElementById('image' + canvasName).appendChild(canvas)
		drawCompleted[getCanvasNum(canvasName)] = true;
	}
	function inverted(id){
		return (id == 2 || id == 4);
	}
	function drawStippling(canvasName,next_question_index){
		var request = new XMLHttpRequest();
		var filenames = filepath 
			+String(methodnames[methodIds[next_question_index]]) + '_' 
			+ String(intensity[next_question_index]) + '_'
			+ String(sizeIds[next_question_index]) + '_'
			+ String(oriIds[next_question_index])
			+ '.txt';
		console.log(next_question_index);	
		console.log(filenames);		
		request.open('GET', filenames, true);
		request.responseType = 'blob';
		
		request.onerror = function() {
			alert("Error: Cannot download images. Code:"
			+ "HTER" 
			+ String(methodnames[methodIds[next_question_index]]) + '.' 
			+ String(intensity[next_question_index]) + '.'
			+ String(sizeIds[next_question_index]) + '.'
			+ String(oriIds[next_question_index])); 
		};
		request.onload = function() {
			var reader = new FileReader();
			reader.readAsArrayBuffer(request.response);
			reader.onload =  function(e){
				setTimeout( function(){
					document.getElementById('questionTable').style.display = "table";
					startTime = Date.now();
				}, REST_TIME);
				var i = new Int32Array(e.target.result.slice(0,16));
				//var f = new Float32Array(e.target.result.slice(methodIds[next_question_index] < 2? 20:16));
				var f = new Float32Array(e.target.result.slice(20));
				var num = Number(i[0]).toString(10);
				var size = Number(i[3]).toString(10);
				
				
				var canvas = document.createElement('canvas');
				canvas.id     = "CursorLayer";
				canvas.width  = img_res_h;
				canvas.height = img_res_h;
				canvas.style.zIndex   = 0;
				canvas.style.position = "absolute";
			
				var ctx = canvas.getContext("2d");
				
				if (inverted(methodIds[next_question_index])){
					ctx.fillStyle="black";
					ctx.fillRect(0,0,img_res_h,img_res_h);
					ctx.fillStyle="white";
				}else {
					ctx.fillStyle="white";
					ctx.fillRect(0,0,img_res_h,img_res_h);
					ctx.fillStyle="black";
				}
				
				
				//error_diffusion = 0;
				//var end_size =  / 2;
				//var drawn = new Array(end_size);
				//drawn.fill(0);
				//float dist = (f[0]-f[2]);
				//double small_angle = acos(dist / radius);
				//double small_circle_area = radius * radius * small_angle / 2; // r^2 pi * small_angle / 2pi
				//double small_triangle_area = dist * dist * tan(small_angle) / 2;
				//double exceed_circle_area = small_circle_area - small_triangle_area;
				
				for (let id = 0; id < f.length; id+=2){
					//var nid = Math.floor(Math.random() * end_size);
					//while(drawn[nid]) nid = (nid + 1) % end_size;
					drawCircle(ctx,Number(f[id]), Number(f[id + 1]), size);
					//if (dist < radius) error_diffusion -= exceed_circle_area * 12;
					//drawn[nid] = 1;
				}
				
				var average_color = avgColor(ctx);
				console.log(average_color);						 
				document.getElementById('average_color' + canvasName + Math.floor(next_question_index/2)).value = average_color;
				document.getElementById('image' + canvasName).appendChild(canvas)
				drawCompleted[getCanvasNum(canvasName)] = true;
			};
		};

		request.send();
	}
	
	function errorPass(){
		return error;
	}
	function endStudy(){
		if(errorPass()){
			changePage('restPage','endStudy');
		}else{
			changePage('restPage','errorStudy');
		}
	}
	function answerLeft(){  answered(0); }
	function answerRight(){ answered(1); }
	function restOK(){ 
		if(answered_question_num < TASK_NUM){ 
			changePage('restPage','questions');
			nextQuestion(); 
		}else{ endStudy(); }
	}
	function answered(index){
		var time = Date.now() - startTime;
		answers[next_question_index] = index;	//0-left 1-right
		console.log((index ? 'R' : 'L'));
		document.getElementById('answer' + next_question_index).value = (index ? 'R' : 'L');
		document.getElementById('time' + next_question_index).value = 	time;
		
		document.getElementById('MA' + next_question_index).value = methodnames[methodIds[next_question_index * 2]];
		document.getElementById('IA' + next_question_index).value = intensity[next_question_index * 2];
		document.getElementById('SA' + next_question_index).value = sizeIds[next_question_index * 2];
		document.getElementById('OA' + next_question_index).value = oriIds[next_question_index * 2];
		document.getElementById('MB' + next_question_index).value = methodnames[methodIds[next_question_index * 2 + 1]];
		document.getElementById('IB' + next_question_index).value = intensity[next_question_index * 2 + 1];
		document.getElementById('SB' + next_question_index).value = sizeIds[next_question_index * 2 + 1];
		document.getElementById('OB' + next_question_index).value = oriIds[next_question_index * 2 + 1];
		
		
		answered_question_num++;
		if(answered_question_num >= TASK_NUM){ changePage('questions','endStudy');}
		else if(answered_question_num % QUESTION_NUM_BEFORE_REST == 0){ changePage('questions','restPage'); }
		else { nextQuestion(); }
	}

</script>
